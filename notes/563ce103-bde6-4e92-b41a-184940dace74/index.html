<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="icon" href="/favicon.ico"/><title>Using Serverless Framework With Aws</title><meta name="robots" content="index,follow"/><meta name="googlebot" content="index,follow"/><meta name="description" content="Personal knowledge Base"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="neurrone"/><meta name="twitter:creator" content="neurrone"/><meta property="og:title" content="Using Serverless Framework With Aws"/><meta property="og:description" content="Personal knowledge Base"/><meta property="og:url" content="https://kb.neurrone.com/notes/563ce103-bde6-4e92-b41a-184940dace74/"/><meta property="og:type" content="article"/><meta property="article:published_time" content="4/3/2021"/><meta property="article:modified_time" content="11/1/2021"/><link rel="canonical" href="https://kb.neurrone.com/notes/563ce103-bde6-4e92-b41a-184940dace74/"/><meta name="next-head-count" content="17"/><link rel="preload" href="/_next/static/css/28568fdc53f6f476e837.css" as="style"/><link rel="stylesheet" href="/_next/static/css/28568fdc53f6f476e837.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-613fd858cdb9cf2af3be.js" defer=""></script><script src="/_next/static/chunks/framework-2f612445bd50b211f15a.js" defer=""></script><script src="/_next/static/chunks/main-12873c707c15119bc57b.js" defer=""></script><script src="/_next/static/chunks/pages/_app-e8d40a71ea3b0629f02c.js" defer=""></script><script src="/_next/static/chunks/155-51163345bd32269f413d.js" defer=""></script><script src="/_next/static/chunks/pages/notes/%5Bid%5D-61b1e2653601d43c9804.js" defer=""></script><script src="/_next/static/t4fyFBTlnKs0Bqt1zHoRW/_buildManifest.js" defer=""></script><script src="/_next/static/t4fyFBTlnKs0Bqt1zHoRW/_ssgManifest.js" defer=""></script></head><body><div id="__next"><section class="ant-layout" style="width:100%;min-height:100%"><header class="ant-layout-header" style="position:fixed;isolation:isolate;z-index:1;width:100%;border-bottom:1px solid #d4dadf;height:64px"><div class="ant-row" style="margin:0 auto"><div class="ant-col ant-col-4"></div><div class="ant-col gutter-row ant-col-xs-0 ant-col-sm-0 ant-col-md-18 ant-col-lg-16"></div></div></header><section class="ant-layout" style="margin-top:64px"><aside class="ant-layout-sider ant-layout-sider-dark" style="position:sticky;top:64px;overflow:auto;height:calc(100vh - 64px);isolation:isolate;z-index:1;flex:0 0 200px;max-width:200px;min-width:200px;width:200px"><div class="ant-layout-sider-children"><div style="height:100%"><div style="display:flex;flex-direction:column;justify-content:space-between;height:100%" class="ant-col"><div class="ant-row" style="margin-left:-0.5px;margin-right:-0.5px;margin:0 auto;padding:1rem"><span class="ant-typography">ðŸŒ± with<!-- --> <a class="ant-typography" href="https://www.dendron.so/" target="_blank" rel="noopener noreferrer">Dendron ðŸŒ²</a></span></div></div></div></div></aside><main class="ant-layout-content main-content" role="main"><section class="ant-layout"></section><section class="ant-layout" style="max-width:1320px;margin:0 auto;padding:0 1.5rem"><div class="ant-row"><div class="ant-col ant-col-24"><div class="ant-row" style="margin-left:-10px;margin-right:-10px"><div style="padding-left:10px;padding-right:10px" class="ant-col ant-col-xs-24 ant-col-md-20"><div><h2 id="api-gateway"><a aria-hidden="true" class="anchor-heading" href="#api-gateway"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Api-gateway</h2>
<p>As at time of writing (Apr 2021), configuring api-gateway with api keys and usage plans is bugged according to the official docs. The docs say to <a href="https://www.serverless.com/framework/docs/deprecations#api-gateway-specific-configuration">put configuration in provider.apigateway, instead of under provider directly</a>.</p>
<p>However, this does not work, and you must place them under provider (the deprecated behaviour) instead.</p>
<h2 id="errors-during-sls-deploy"><a aria-hidden="true" class="anchor-heading" href="#errors-during-sls-deploy"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Errors During sls deploy</h2>
<p>Sometimes, deploying the cloud formation stack fails with errors such as "stack not found".</p>
<p>The error messages are horrible; errors in the serverless.yml file could cause it. This is probably caused by the error causing the stack creation to fail, resulting in subsequent commands not being able to use it.</p>
<h2 id="check-lambda-permissions"><a aria-hidden="true" class="anchor-heading" href="#check-lambda-permissions"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Check Lambda Permissions</h2>
<pre class="language-sh"><code class="language-sh">aws iam get-role-policy --role-name &#x3C;function role> --policy-name &#x3C;policy name>

# to get the function role
aws lambda get-function --function-name &#x3C;function>

# to get policy name
aws iam list-role-policies --role-name &#x3C;role>
</code></pre>
<h2 id="troubleshooting-sqs-invocations"><a aria-hidden="true" class="anchor-heading" href="#troubleshooting-sqs-invocations"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Troubleshooting SQS Invocations</h2>
<p>When configuring a lambda function to run on receipt of an SQS message, I ran into the following problems, these are useful things to check to troubleshoot the problem.</p>
<ul>
<li>Check if the event source mapping got disabled. I had this happen to me even though at the code level it was enabled, so I am not sure why.
<pre class="language-sh"><code class="language-sh">aws lambda list-event-source-mappings --function-name &#x3C;function-name>
# if the state shows as being disabled, re-enable it:
aws lambda   update-event-source-mapping --uuid &#x3C;uuid from previous command> --enabled
</code></pre>
</li>
<li>Check if the queue has the expected attributes set, especially if using encryption: <code>aws sqs get-queue-attributes --queue-url &#x3C;url> --attribute-names All</code></li>
<li>If the queue uses encryption, ensure that the lambda has the <a href="/notes/slIGj2pqttjbdwc0QlUaQ">necessary permissions to encrypt / decrypt the messages</a>. Otherwise, messages get dropped silently.</li>
</ul></div></div><div style="padding-left:10px;padding-right:10px" class="ant-col ant-col-xs-0 ant-col-md-4"><div><div class=""><div class="ant-anchor-wrapper" style="max-height:calc(100vh - 64px);z-index:1"><div class="ant-anchor"><div class="ant-anchor-ink"><span class="ant-anchor-ink-ball"></span></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#api-gateway" title="Api Gateway">Api Gateway</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#errors-during-sls-deploy" title="Errors During sls deploy">Errors During sls deploy</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#check-lambda-permissions" title="Check Lambda Permissions">Check Lambda Permissions</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#troubleshooting-sqs-invocations" title="Troubleshooting SQS Invocations">Troubleshooting SQS Invocations</a></div></div></div></div></div></div></div></div></div></section><section class="ant-layout" style="max-width:1180px"><div class="ant-divider ant-divider-horizontal" role="separator"></div><footer class="ant-layout-footer"></footer></section></main></section></section></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"note":{"id":"563ce103-bde6-4e92-b41a-184940dace74","title":"Using Serverless Framework With Aws","vault":{"name":"main","fsPath":"main","useFMTitle":false},"type":"note","desc":"Gotchas when using the serverless framework with AWS","links":[{"type":"wiki","from":{"fname":"tools.serverless.aws","id":"563ce103-bde6-4e92-b41a-184940dace74","vaultName":"main"},"value":"tools.aws.sqs","alias":"necessary permissions to encrypt / decrypt the messages","position":{"start":{"line":38,"column":64,"offset":1859},"end":{"line":38,"column":137,"offset":1932},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"tools.aws.sqs"}}],"anchors":{"api-gateway":{"type":"header","text":"Api-gateway","value":"api-gateway","line":8,"column":0},"errors-during-sls-deploy":{"type":"header","text":"Errors During sls deploy","value":"errors-during-sls-deploy","line":14,"column":0},"check-lambda-permissions":{"type":"header","text":"Check Lambda Permissions","value":"check-lambda-permissions","line":20,"column":0},"troubleshooting-sqs-invocations":{"type":"header","text":"Troubleshooting SQS Invocations","value":"troubleshooting-sqs-invocations","line":32,"column":0}},"fname":"tools.serverless.aws","updated":1635737736937,"created":1617456663738,"parent":"93e0f902-47d4-4cc7-9027-5de0012f6c57","children":[],"data":{},"contentHash":"1de00572bc3cdd94580a5765fba04a3d","custom":{}},"body":"\u003ch2 id=\"api-gateway\"\u003e\u003ca aria-hidden=\"true\" class=\"anchor-heading\" href=\"#api-gateway\"\u003e\u003csvg aria-hidden=\"true\" viewBox=\"0 0 16 16\"\u003e\u003cuse xlink:href=\"#svg-link\"\u003e\u003c/use\u003e\u003c/svg\u003e\u003c/a\u003eApi-gateway\u003c/h2\u003e\n\u003cp\u003eAs at time of writing (Apr 2021), configuring api-gateway with api keys and usage plans is bugged according to the official docs. The docs say to \u003ca href=\"https://www.serverless.com/framework/docs/deprecations#api-gateway-specific-configuration\"\u003eput configuration in provider.apigateway, instead of under provider directly\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eHowever, this does not work, and you must place them under provider (the deprecated behaviour) instead.\u003c/p\u003e\n\u003ch2 id=\"errors-during-sls-deploy\"\u003e\u003ca aria-hidden=\"true\" class=\"anchor-heading\" href=\"#errors-during-sls-deploy\"\u003e\u003csvg aria-hidden=\"true\" viewBox=\"0 0 16 16\"\u003e\u003cuse xlink:href=\"#svg-link\"\u003e\u003c/use\u003e\u003c/svg\u003e\u003c/a\u003eErrors During sls deploy\u003c/h2\u003e\n\u003cp\u003eSometimes, deploying the cloud formation stack fails with errors such as \"stack not found\".\u003c/p\u003e\n\u003cp\u003eThe error messages are horrible; errors in the serverless.yml file could cause it. This is probably caused by the error causing the stack creation to fail, resulting in subsequent commands not being able to use it.\u003c/p\u003e\n\u003ch2 id=\"check-lambda-permissions\"\u003e\u003ca aria-hidden=\"true\" class=\"anchor-heading\" href=\"#check-lambda-permissions\"\u003e\u003csvg aria-hidden=\"true\" viewBox=\"0 0 16 16\"\u003e\u003cuse xlink:href=\"#svg-link\"\u003e\u003c/use\u003e\u003c/svg\u003e\u003c/a\u003eCheck Lambda Permissions\u003c/h2\u003e\n\u003cpre class=\"language-sh\"\u003e\u003ccode class=\"language-sh\"\u003eaws iam get-role-policy --role-name \u0026#x3C;function role\u003e --policy-name \u0026#x3C;policy name\u003e\n\n# to get the function role\naws lambda get-function --function-name \u0026#x3C;function\u003e\n\n# to get policy name\naws iam list-role-policies --role-name \u0026#x3C;role\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"troubleshooting-sqs-invocations\"\u003e\u003ca aria-hidden=\"true\" class=\"anchor-heading\" href=\"#troubleshooting-sqs-invocations\"\u003e\u003csvg aria-hidden=\"true\" viewBox=\"0 0 16 16\"\u003e\u003cuse xlink:href=\"#svg-link\"\u003e\u003c/use\u003e\u003c/svg\u003e\u003c/a\u003eTroubleshooting SQS Invocations\u003c/h2\u003e\n\u003cp\u003eWhen configuring a lambda function to run on receipt of an SQS message, I ran into the following problems, these are useful things to check to troubleshoot the problem.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eCheck if the event source mapping got disabled. I had this happen to me even though at the code level it was enabled, so I am not sure why.\n\u003cpre class=\"language-sh\"\u003e\u003ccode class=\"language-sh\"\u003eaws lambda list-event-source-mappings --function-name \u0026#x3C;function-name\u003e\n# if the state shows as being disabled, re-enable it:\naws lambda   update-event-source-mapping --uuid \u0026#x3C;uuid from previous command\u003e --enabled\n\u003c/code\u003e\u003c/pre\u003e\n\u003c/li\u003e\n\u003cli\u003eCheck if the queue has the expected attributes set, especially if using encryption: \u003ccode\u003eaws sqs get-queue-attributes --queue-url \u0026#x3C;url\u003e --attribute-names All\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eIf the queue uses encryption, ensure that the lambda has the \u003ca href=\"/notes/slIGj2pqttjbdwc0QlUaQ\"\u003enecessary permissions to encrypt / decrypt the messages\u003c/a\u003e. Otherwise, messages get dropped silently.\u003c/li\u003e\n\u003c/ul\u003e","noteIndex":{"id":"root","title":"root","vault":{"name":"main","fsPath":"main","useFMTitle":false},"type":"note","desc":"","links":[],"anchors":{"personal-knowledge-base":{"type":"header","text":"Personal Knowledge Base","value":"personal-knowledge-base","line":9,"column":0}},"fname":"root","updated":1622102326440,"created":1595961348801,"parent":null,"children":["9fa47ef8-a44b-4e36-929f-4aa7835b474d","6e43ea37-b3e7-44cf-aac7-31ae947d32a2","a10a1802-11d0-4557-a374-89712109cf90","0b9beaed-19ee-4124-a880-07e520da2b17","ddf3e9b2-ea12-4129-8785-06d6b82d4fcb","65swI4wiTjaw7fQsGQqKC","b4be93a8-69e3-4427-b4cd-53593c3ab387","5bbec2d1-4abe-4a2a-8bc5-5f3d4e229766","4a064a97-3d2d-4429-9a08-5b158dc7ef35","543e830d-feac-4048-8075-58c406bc1105","8875d2cf-85f8-41e8-b16d-c3707e40d74e","8ec37b11-59ad-4ea8-82d9-3186e7e0cd29","dOehc8Yap1zIbEqLvQvOt","b58269ed-9a0e-4213-b5b0-6d59c81d9899","b4fc6d48-17ae-4764-acdb-ec0f52707860","091b67bf-8bfa-454c-bbd3-7d84d8216229","f6fbee87-be27-471c-99bd-4af45d6a3156","fb9e4130-eaf8-425d-9039-5bc2ee876f18","4fb536a9-c146-4df3-8f30-9b2fb52a77f7","21ef758d-ca84-4be0-8eed-5e95ab3b4a7e","5fb5baa9-8b3d-4044-9c03-bbabfbdfe78a","2f6af89e-df82-4144-87fc-a2be66a0e657","POgyWcSIqi29tpqfP5uyS","gejtw6zG3oA4WfIXlYR0H"],"data":{},"contentHash":"2222728f026e86e75d06a6048c4f43ed","custom":{"stub":false,"nav_order":0,"permalink":"/"},"body":"\n# Personal Knowledge Base\n\nHi, and welcome to [Dickson Tan's](https://neurrone.com/pages/about/) personal knowledge base.\n\nThis is an experiment in note taking with the Zettelkasten method. This site is rendered with [Dendron](https://wiki.dendron.so/) which generates backlinks and an index, and provides other convenience features.\n"},"collectionChildren":null,"customHeadContent":null,"config":{"version":3,"useFMTitle":false,"useNoteTitleForLink":true,"noLegacyNoteRef":true,"mermaid":true,"useKatex":true,"usePrettyRefs":true,"dev":{"previewV2Enabled":false,"enablePreviewV2":true},"site":{"copyAssets":true,"siteHierarchies":["root"],"siteLastModified":true,"siteRootDir":"docs","siteUrl":"https://kb.neurrone.com","usePrettyRefs":true,"title":"Personal Knowledge Base","description":"Personal knowledge Base","author":"Dickson Tan","twitter":"neurrone","duplicateNoteBehavior":{"action":"useVault","payload":["main","health","Human Dynamics"]},"gh_edit_branch":"main","usePrettyLinks":true,"siteNotesDir":"notes","siteFaviconPath":"favicon.ico","gh_edit_link":true,"gh_edit_link_text":"Edit this page on GitHub","gh_root":"docs/","gh_edit_view_mode":"edit","writeStubs":true,"siteIndex":"root"},"commands":{"lookup":{"note":{"selectionMode":"extract","confirmVaultOnCreate":false,"leaveTrace":false,"bubbleUpCreateNew":true}},"insertNote":{"initialValue":"templates"},"insertNoteLink":{"aliasMode":"none","enableMultiSelect":false},"insertNoteIndex":{"enableMarker":false},"randomNote":{}},"workspace":{"dendronVersion":"0.64.1","vaults":[{"fsPath":"human-dynamics","name":"Human Dynamics","useFMTitle":false},{"name":"govtech","fsPath":"govtech","visibility":"private","useFMTitle":false},{"name":"health","fsPath":"health","useFMTitle":false},{"name":"main","fsPath":"main","useFMTitle":false},{"name":"personal","fsPath":"personal","visibility":"private"}],"journal":{"dailyDomain":"daily","name":"journal","dateFormat":"y.MM.dd","addBehavior":"childOfDomain"},"scratch":{"name":"scratch","dateFormat":"y.MM.dd.HHmmss","addBehavior":"asOwnDomain"},"graph":{"zoomSpeed":1},"disableTelemetry":true,"enableAutoCreateOnDefinition":false,"enableXVaultWikiLink":false,"enableRemoteVaultInit":true,"workspaceVaultSyncMode":"noCommit","enableAutoFoldFrontmatter":false,"maxPreviewsCached":10,"maxNoteLength":204800,"enableUserTags":true,"enableHashTags":true,"task":{"name":"","dateFormat":"","addBehavior":"childOfCurrent","statusSymbols":{"":" ","wip":"w","done":"x","assigned":"a","moved":"m","blocked":"b","delegated":"l","dropped":"d","pending":"y"},"prioritySymbols":{"H":"high","M":"medium","L":"low"},"todoIntegration":false,"createTaskSelectionType":"selection2link"}},"preview":{"enableFMTitle":true,"enableNoteTitleForLink":true,"enableMermaid":true,"enablePrettyRefs":true,"enableKatex":true}}},"__N_SSG":true},"page":"/notes/[id]","query":{"id":"563ce103-bde6-4e92-b41a-184940dace74"},"buildId":"t4fyFBTlnKs0Bqt1zHoRW","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>